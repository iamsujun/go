<html>
<body>
<title>Fight</title>
<style type="text/css">
div {
  margin: auto;
	width: 660px;
	height: 360px;
	border: 1px solid #000;
}
ul {
	width: 310px;
	height: 310px;
	padding: 10px;
	border: 0px solid #000;
	float: left;
	list-style: none;
}
li {
	width: 100px;
	height: 100px;
	float: left;
	margin: 1px;
	background: #eee;
}
.gray {
	background: #bbb;
}
.red {
	background: #ff3333;
}
.green {
	background: #99ff66;
}
.black {
	background: #000;
}
</style>
<body>
<script type="text/javascript">
function $ (elemId) {
	return document.getElementById(elemId);
}
function createElem (tagName) {
	return document.createElement(tagName);
}

var leftUlElem = createElem( 'ul' );
var liElem = createElem( 'li' );
for (var i = 1, len = 10; i < len; i++) {
	leftUlElem.appendChild( liElem.cloneNode() );
};
var divElem = createElem( 'div' );
var rightUlElem = leftUlElem.cloneNode(1);
leftUlElem.id='leftRoles';
rightUlElem.id='rightRoles';
divElem.appendChild( leftUlElem );
divElem.appendChild( rightUlElem );
document.body.appendChild( divElem );

var timeSpan = createElem( 'span' );
timeSpan.id = 'timeSpan';
document.body.appendChild( timeSpan );

/**
 * 战斗模型信息
 * @type {Object}
 * 模型编号 : [ 站立动作时长, 攻击动作时长, 被攻击动作时长, 死亡动作时长 ]
 */
var modelList = {
	1001 : [ 1, 6, 5, 2 ],
	1002 : [ 1, 7, 5, 2 ],
	1003 : [ 1, 8, 5, 2 ],
	1004 : [ 1, 6, 5, 2 ]
};
var fightArea = {
	1 : [  ]
}

var leftRoles = {
	0: { 'model': 1004, 'life': 300, 'speed': 3, 'fight': 128 },
	5: { 'model': 1002, 'life': 300, 'speed': 6, 'fight': 130 },
	7: { 'model': 1003, 'life': 300, 'speed': 7, 'fight': 158 }
};
var rightRoles = {
	4: { 'model': 1002, 'life': 300, 'speed': 4, 'fight': 138 },
	6: { 'model': 1004, 'life': 300, 'speed': 5, 'fight': 156 },
	8: { 'model': 1001, 'life': 300, 'speed': 7, 'fight': 160 }
};
/**
 * 阵型初始化
 */
for ( var j=0; j < 9; j++ ) {
	if ( isset( leftRoles[ j ] ) ) {
		playModel( 0, j, leftRoles[ j ][ 'model' ], 0 );
	}
	if ( isset( rightRoles[ j ] ) ) {
		playModel( 1, j, rightRoles[ j ][ 'model' ], 0 );
	}
}
/**
 * 战斗计算
 */
var maxTime = 20, dataList = [], positions=[3,0,6,4,1,7,5,2,8];
var len = leftRoles.length, j;
var team = [ leftRoles, rightRoles ], opIndex = [ 1, 0 ], side;
for (var i = 1; i < maxTime; i++) {
	for ( j in positions ) {
		pos = positions[ j ];
		for( side in team )
		{
			if ( isset( team[ side ][ pos ] ) ) {
				fightOnce ( side, opIndex[ side ], team[ side ][ pos ], team[ opIndex[ side ] ] );
			}
		}
	};
};

/**
 * 一次出手计算
 * @param  {int} side    队伍位置（0：左侧，1：右侧）
 * @param  {int} opSide  对战方位置
 * @param  {array} role    攻击者信息
 * @param  {array} opRoles 被攻击对我信息
 * @return {void}
 */
function fightOnce ( side, opSide, role, opRoles ) {
	if ( i % role[ 'speed' ] == 0 && role[ 'life' ] > 0 ) {
		add( [ side, pos, role[ 'model' ], 1 ] );
		var indexs = findOp( pos, 1 );
		for( var r in indexs )
		{
			if ( isset( opRoles[ indexs[ r] ] ) && opRoles[ indexs[ r] ][ 'life' ] > 0 ) {
				add( [ opSide, indexs[ r], opRoles[ indexs[ r] ][ 'model' ], 2 ] );
				opRoles[ indexs[ r] ][ 'life' ] -= role[ 'fight' ];
				if ( opRoles[ indexs[ r] ][ 'life' ] <= 0 ) {
					add( [ opSide, indexs[ r], opRoles[ indexs[ r] ][ 'model' ], 3 ] );
				};
				break;
			};
		}
	};
}

/**
 * 计算被攻击顺序
 * @param  {int} pos 攻击者在队伍中位置
 * @param  {int} act 攻击动作编号
 * @return {array}     被攻击序列
 */
function findOp (pos, act) {
	var indexs;
	switch ( parseInt(pos)  )
	{
		case 0:
		case 1:
		case 2:
			indexs = [ 0, 1, 2, 3, 4, 5, 6, 7, 8 ];
		break;
		case 3:
		case 4:
		case 5:
			indexs = [ 3, 4, 5, 0, 1, 2, 6, 7, 8 ];
		break;
		case 6:
		case 7:
		case 8:
			indexs = [ 6, 7, 8, 3, 4, 5, 0, 1, 2 ];
		break;
	}
	return indexs;
}
function isset (value) {
	return typeof value != 'undefined';
}
function add(data){
	dataList.push( data );
}

var currSec=0, baseSpeed=100, currData;
function debug (value) {
	console.debug( value );
}

function play () {
	if ( currSec >= dataList.length ) {
		return;
	};
	currData = dataList[ currSec ];
	currSec++;
	timeSpan.innerHTML = currSec;
	playFrame();
}
function playFrame () {
	playModel( currData[ 0 ], currData[ 1 ], currData[ 2 ], currData[ 3 ] );
}
function clearFrame() {
	playModel( currData[ 0 ], currData[ 1 ], currData[ 2 ], 0 );
}
play();

function playModel (pos,index, modelId, act) {
	var objs = [ leftUlElem, rightUlElem ];
	var teams = [
		[ 2, 1, 0, 5, 4, 3, 8, 7, 6 ],
		[ 0, 1, 2, 3, 4, 5, 6, 7, 8 ]
	];
	var teamPos = teams[ pos ][ index ];
	var obj = objs[ pos ].childNodes[ teamPos ];
	var colors = { 0: 'gray', 1 : 'green', 2: 'red', 3: 'black' };
	obj.className = colors[act];
	obj.innerHTML = '';
	if (act == 0) {
		return
	};
	
	var n=0, sign = setInterval( function(){
		obj.innerHTML = n;
		if ( n++ >= modelList[ modelId ][ act ] ) {
			clearInterval( sign );
			if (act != 3) {
				clearFrame();
			};
			play();
		};
	}, baseSpeed );
}
</script>
</body>
</body>
</html>
